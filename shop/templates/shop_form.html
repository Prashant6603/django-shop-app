{% extends "base.html" %}

{% block content %}

<h3>Add / Update Shop</h3>

<form method="POST" class="mt-3">
    {% csrf_token %}

    <div class="mb-3">
        {{ form.name.label_tag }}
        {{ form.name }}
    </div>

    <div class="mb-3">
        {{ form.address.label_tag }}
        {{ form.address }}
    </div>

    <div class="mb-3">
        {{ form.category.label_tag }}
        {{ form.category }}
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            {{ form.latitude.label_tag }}
            {{ form.latitude }}
        </div>

        <div class="col-md-6">
            {{ form.longitude.label_tag }}
            {{ form.longitude }}
        </div>
    </div>

    <label class="fw-bold">Click on map to select location:</label>

    <!-- MAP DIV -->
    <div id="map" style="height: 400px; border: 1px solid #ccc;"></div>

    <button class="btn btn-success mt-3">Save Shop</button>
</form>

<!-- MAP SCRIPT (Leaflet already loaded from base.html) -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    console.log("Map script loaded.");  // DEBUG

    var map = L.map('map').setView([20.5937, 78.9629], 5);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    var marker = null;

    {% if form.instance.latitude %}
        marker = L.marker([{{ form.instance.latitude }}, {{ form.instance.longitude }}]).addTo(map);
        map.setView([{{ form.instance.latitude }}, {{ form.instance.longitude }}], 14);
    {% endif %}

    map.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        console.log("Clicked at:", lat, lng);  // DEBUG

        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lng;

        if (marker) {
            map.removeLayer(marker);
        }

        marker = L.marker([lat, lng]).addTo(map);
    });

});
</script>

{% endblock %}
